rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function isAdminOrManagerForStore(storeId) {
      return isAuthenticated()
        && (
          getUserDoc().data.role in ['ADMIN', 'MANAGER']
          || getUserDoc().data.rolesByStore[storeId] in ['ADMIN', 'MANAGER']
        );
    }

    function isOwnUser(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }

    function hasOnlyPreferenceFields() {
      return request.resource.data.diff(resource.data).changedKeys().hasOnly(['preferences']);
    }

    function isValidPreferencePayload() {
      return request.resource.data.preferences.keys().hasOnly(['themeMode', 'uiAccentColor', 'updatedAt'])
        && request.resource.data.preferences.themeMode in ['light', 'dark']
        && (
          !('uiAccentColor' in request.resource.data.preferences)
          || request.resource.data.preferences.uiAccentColor is string
        );
    }

    match /stores/{storeId} {
      allow read: if true;
      allow create, delete: if false;

      // Branding + disponibilidade gerenciada por ADMIN/MANAGER.
      allow update: if isAdminOrManagerForStore(storeId);
    }

    match /stores_public/{storeId} {
      allow read: if true;
      allow write: if false;
    }

    match /users/{uid} {
      allow read: if isOwnUser(uid);
      allow create: if isOwnUser(uid)
        && request.resource.data.keys().hasOnly(['preferences']);
      allow update: if isOwnUser(uid)
        && hasOnlyPreferenceFields()
        && isValidPreferencePayload();
      allow delete: if false;
    }

    match /lojas/{lojaId} {
      allow read: if true;
      allow write: if isAuthenticated();

      match /pedidos/{pedidoId} {
        allow read: if isAuthenticated();
        // Bloqueia escrita direta no cliente: pedidos devem passar por Cloud Function createOrder.
        allow create, update, delete: if false;
      }

      match /{subCollection}/{docId} {
        allow read: if true;
        allow write: if isAuthenticated();
      }
    }

    match /pedidos/{pedidoId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if false;
    }

    match /{document=**} {
      allow read, write: if isAuthenticated();
    }
  }
}
